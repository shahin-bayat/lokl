# lokl.yaml - Development environment configuration
# This example is based on a monorepo with multiple frontend apps and backend services.

name: myproject # Project identifier (required)
version: "1" # Config version for future compatibility

# Proxy configuration for HTTPS routing
proxy:
  domain: myproject.dev # Base domain - services get subdomains like app.myproject.dev
  https: true # Enable HTTPS with auto-generated certificates (default: true)

# Global environment variables available to all services
env:
  NODE_ENV: development
  LOG_LEVEL: debug

services:
  # Frontend app with SPA routing
  web:
    command: pnpm dev # Command to start the service
    path: ./apps/web # Working directory relative to lokl.yaml

    port: 8080 # Port the service listens on
    subdomain: app # Creates https://app.myproject.dev

    # Optional: Path rewriting (only needed for SPAs or monorepo path prefixes)
    rewrite:
      strip_prefix: web # Strip /web prefix from paths
      fallback: /index.html # SPA fallback for client-side routing

    env:
      VITE_API_URL: https://api.myproject.dev

    depends_on:
      - api # Start api before this service

    health:
      path: / # HTTP path to check
      interval: 10s # How often to check
      timeout: 3s # Request timeout
      retries: 3 # Failures before marking unhealthy

    ready_timeout: 30s # Max time to wait for service to be ready
    restart: on-failure # Restart policy: always | on-failure | never

  # API server
  api:
    command: pnpm dev
    path: ./apps/api

    port: 3001
    subdomain: api # https://api.myproject.dev

    env:
      DATABASE_URL: postgresql://app:dev@localhost:5432/myproject_dev
      REDIS_URL: redis://localhost:6379

    depends_on:
      - postgres
      - redis

    health:
      path: /health
      interval: 10s
    limits:
      memory: 512M # Memory limit for the service

  # Storybook - component library docs
  storybook:
    path: ./packages/ui
    command: pnpm storybook
    port: 6006
    subdomain: storybook # https://storybook.myproject.dev
    autostart: false # Don't start with `lokl up` (default: true)

  # Docker-based database
  postgres:
    image: postgres:15 # Docker image (mutually exclusive with command)
    port: 5432
    env:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: dev
      POSTGRES_DB: myproject_dev
    volumes:
      - ./.lokl/postgres:/var/lib/postgresql/data

  # Docker-based cache
  redis:
    image: redis:7-alpine
    port: 6379
